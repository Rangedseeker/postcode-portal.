
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Postcode Portal</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#a8b3cf; --text:#e8eeff; --accent:#60a5fa;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#22314f; 
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    h1{font-size:20px;margin:0 0 8px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0e1729;color:var(--text);outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    .pill{display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted)}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:10px}
    .topbar{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .topmatch{display:grid;gap:8px}
    .topmatch table{width:100%;border-collapse:collapse}
    .topmatch td{border-top:1px solid var(--line);padding:8px 0}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi .card{padding:16px}
    .kpi h3{margin:0 0 8px;font-size:12px;color:var(--muted);font-weight:600}
    .kpi .val{font-size:22px}
    .small{font-size:12px}
    .sticky-dup{position:sticky;top:0;background:linear-gradient(#0b1220, #0b1220ee);z-index:10;padding-top:8px;padding-bottom:6px;border-bottom:1px solid var(--line)}
    @media (max-width:840px){
      .row,.topbar,.kpi{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- PRIMARY TOP SECTION -->
    <div class="card grid" id="primaryTop">
      <h1>Lookup</h1>
      <div class="topbar">
        <div>
          <label for="countrySearch">Country (UK / BEL / NL / LUX)</label>
          <input id="countrySearch" list="countryList" placeholder="Type UK, BEL, NL, or LUX and press Enter" autocomplete="off" />
          <datalist id="countryList"></datalist>
        </div>
        <div>
          <label for="postcodeSearch">Postcode</label>
          <input id="postcodeSearch" placeholder="Start typing a postcode and press Enter" autocomplete="off" disabled />
        </div>
      </div>

      <div class="topmatch card">
        <div class="pill"><span>Top matching row</span><span id="matchCount" class="muted"></span></div>
        <div id="topMatchPrimary">
          <div class="muted small">No match yet — start typing a postcode</div>
        </div>
      </div>
    </div>

    <!-- DUPLICATED TOP SECTION ABOVE NUMBERS -->
    <div class="sticky-dup">
      <div class="row">
        <div class="card">
          <strong class="muted small">Country / Postcode</strong><br/>
          <span id="dupCountry" class="pill">—</span>
          <span id="dupPostcode" class="pill">—</span>
        </div>
        <div class="card" id="topMatchSecondary">
          <strong class="muted small">Top matching row</strong>
          <div class="muted small">—</div>
        </div>
      </div>
    </div>

    <!-- NUMBERS / KPIs (your existing area; keep as-is if you have one) -->
    <div class="kpi">
      <div class="card"><h3>Total records (loaded)</h3><div class="val" id="statTotal">0</div></div>
      <div class="card"><h3>Country</h3><div class="val" id="statCountry">—</div></div>
      <div class="card"><h3>Postcode committed</h3><div class="val" id="statPostcode">—</div></div>
      <div class="card"><h3>Search hits (current)</h3><div class="val" id="statHits">0</div></div>
    </div>

    <!-- You can keep your table/results section below if you like. -->
  </div>

<script>
/** ==================== CONFIG ==================== **/

// Country list limited to your four choices:
const COUNTRIES = [
  { code: 'UK',  name: 'United Kingdom', data: 'postcodes_uk.json'  },
  { code: 'BEL', name: 'Belgium',        data: 'postcodes_bel.json' },
  { code: 'NL',  name: 'Holland',        data: 'postcodes_nl.json'  },
  { code: 'LUX', name: 'Luxembourg',     data: 'postcodes_lux.json' }
];

// DOM handles
const countrySearch   = document.getElementById('countrySearch');
const countryList     = document.getElementById('countryList');
const postcodeSearch  = document.getElementById('postcodeSearch');
const topMatchPrimary = document.getElementById('topMatchPrimary');
const topMatchSecondary = document.getElementById('topMatchSecondary');
const matchCount      = document.getElementById('matchCount');
const statTotal       = document.getElementById('statTotal');
const statCountry     = document.getElementById('statCountry');
const statPostcode    = document.getElementById('statPostcode');
const statHits        = document.getElementById('statHits');
const dupCountry      = document.getElementById('dupCountry');
const dupPostcode     = document.getElementById('dupPostcode');

// Build datalist
COUNTRIES.forEach(c => {
  const opt = document.createElement('option');
  opt.value = c.code;
  opt.label = `${c.code} – ${c.name}`;
  countryList.appendChild(opt);
});

// State
let selectedCountry = null;      // 'UK' | 'BEL' | 'NL' | 'LUX'
let dataRows = [];               // normalized {postcode, region}
let currentHits = [];            // latest filtered list
let committedPostcode = null;    // string

/** ==================== HELPERS ==================== **/

function normalizeRow(r){
  // Accept both our new JSON ({postcode, region}) and the old UK JSON shape
  const postcode = (r.postcode ?? r.Postcode ?? r.code ?? r.pc ?? '').toString().trim();
  const region   = (r.region   ?? r.Region   ?? r.Town ?? r['Town/Area'] ?? r.Area ?? '').toString().trim();
  return { postcode, region };
}

function renderTopMatch(targetEl, row){
  if(!row){
    targetEl.innerHTML = `<div class="muted small">No match</div>`;
    return;
  }
  targetEl.innerHTML = `
    <table>
      <tr><td class="muted small">Postcode</td><td><strong>${row.postcode}</strong></td></tr>
      <tr><td class="muted small">Town / Area</td><td>${row.region || '—'}</td></tr>
    </table>
  `;
}

function updateStats(){
  statTotal.textContent    = dataRows.length.toLocaleString();
  statCountry.textContent  = selectedCountry ?? '—';
  statPostcode.textContent = committedPostcode ?? '—';
  statHits.textContent     = currentHits.length.toLocaleString();
  dupCountry.textContent   = selectedCountry ?? '—';
  dupPostcode.textContent  = committedPostcode ?? '—';
}

function score(row, q){
  // Prefer startsWith; then includes. Lower is better (0 = best)
  const p = row.postcode.toLowerCase();
  if (p === q) return 0;
  if (p.startsWith(q)) return 1;
  if (p.includes(q)) return 2;
  return 9;
}

function filterPostcodes(q){
  if(!q){ currentHits = []; return; }
  const qq = q.trim().toLowerCase();
  currentHits = dataRows
    .filter(r => r.postcode.toLowerCase().includes(qq))
    .sort((a,b)=> score(a,qq) - score(b,qq) || a.postcode.localeCompare(b.postcode))
    .slice(0, 100); // cap for perf
}

/** ==================== LOADERS ==================== **/

async function loadCountry(code){
  const item = COUNTRIES.find(c => c.code.toLowerCase() === code.toLowerCase());
  if(!item) return;
  selectedCountry = item.code;
  statCountry.textContent = selectedCountry;
  dupCountry.textContent = selectedCountry;
  countrySearch.value = selectedCountry;

  // Load JSON
  dataRows = [];
  renderTopMatch(topMatchPrimary, null);
  renderTopMatch(topMatchSecondary, null);
  committedPostcode = null;
  postcodeSearch.value = '';
  postcodeSearch.disabled = true;
  updateStats();

  try{
    const res = await fetch(item.data, { cache: 'no-store' });
    const raw = await res.json();
    dataRows = (Array.isArray(raw) ? raw : []).map(normalizeRow)
      .filter(r => r.postcode && r.region != null);
    postcodeSearch.disabled = false;
  }catch(e){
    console.error('Failed to load data for', item.code, e);
  }
  updateStats();
}

/** ==================== ENTER-TO-COMMIT HANDLERS ==================== **/

// Country: Enter commits exact or first suggestion (we restrict to known codes)
countrySearch.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  const typed = (countrySearch.value || '').trim().toUpperCase();
  const exact = COUNTRIES.find(c => c.code === typed);
  const pick  = exact || COUNTRIES.find(c => c.code.startsWith(typed));
  if (pick){
    e.preventDefault();
    loadCountry(pick.code);
  }
});

// Postcode: Enter commits (1) exact match; else (2) top suggestion
postcodeSearch.addEventListener('input', ()=>{
  const q = (postcodeSearch.value || '').trim();
  filterPostcodes(q);
  matchCount.textContent = currentHits.length ? `(${currentHits.length} hits)` : '';
  const first = currentHits[0] || null;
  renderTopMatch(topMatchPrimary, first);
  renderTopMatch(topMatchSecondary, first);
  updateStats();
});

postcodeSearch.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  const typed = (postcodeSearch.value || '').trim();
  if(!typed) return;

  const typedLower = typed.toLowerCase();
  // 1) exact
  let chosen = dataRows.find(r => r.postcode.toLowerCase() === typedLower);
  // 2) else top suggestion
  if(!chosen){
    filterPostcodes(typed);
    chosen = currentHits[0];
  }

  if(chosen){
    e.preventDefault();
    committedPostcode = chosen.postcode;
    postcodeSearch.value = committedPostcode; // normalize spacing/case
    renderTopMatch(topMatchPrimary, chosen);
    renderTopMatch(topMatchSecondary, chosen);
    updateStats();
  }
});

/** ==================== INIT ==================== **/

// Default to UK on first load
loadCountry('UK');

</script>
</body>
</
